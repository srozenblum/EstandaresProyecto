[patients_samples_variants]
db.patients.aggregate([
  {
    "$lookup": {
      "from": "samples",
      "localField": "patient_id",
      "foreignField": "patient.id",
      "as": "samples"
    }
  },
  {
    "$lookup": {
      "from": "variants",
      "let": { "sample_ids": "$samples.sample_id" },
      "pipeline": [
        {
          "$match": {
            "$expr": { "$in": ["$samples.tumor_sample", "$$sample_ids"] }
          }
        },
        {
          "$project": {
            "_id": 0,
            "variant_id": 1,
            "gene": "$gene.symbol",
            "classification": "$classification.variant_class",
            "consequence": "$classification.consequence",
            "samples": 1
          }
        }
      ],
      "as": "variants"
    }
  },
  {
    "$project": {
      "_id": 0,
      "patient_id": 1,
      "clinical": 1,
      "survival": 1,
      "recurrence": 1,
      "samples": 1,
      "variants": 1
    }
  }
])


[variants_with_oncokb]
db.variants.aggregate([
  {
    "$lookup": {
      "from": "oncokb_genes",
      "localField": "gene.symbol",
      "foreignField": "HugoSymbol",
      "as": "oncokb"
    }
  },
  {
    "$lookup": {
      "from": "samples",
      "localField": "samples.tumor_sample",
      "foreignField": "sample_id",
      "as": "sample_info"
    }
  },
  {
    "$lookup": {
      "from": "patients",
      "localField": "sample_info.patient.id",
      "foreignField": "patient_id",
      "as": "patient"
    }
  },
  { "$unwind": "$patient" },
  {
    "$project": {
      "_id": 0,
      "variant_id": 1,
      "gene": "$gene.symbol",
      "classification": "$classification.variant_class",
      "consequence": "$classification.consequence",
      "sample": "$samples.tumor_sample",
      "patient_id": "$patient.patient_id",
      "oncogenic": { "$arrayElemAt": ["$oncokb.oncogenic", 0] },
      "cancer_gene_type": { "$arrayElemAt": ["$oncokb.geneType", 0] }
    }
  }
])


[variants_full_info]
db.variants.aggregate([
  {
    "$lookup": {
      "from": "samples",
      "localField": "samples.tumor_sample",
      "foreignField": "sample_id",
      "as": "sample"
    }
  },
  { "$unwind": "$sample" },
  {
    "$lookup": {
      "from": "patients",
      "localField": "sample.patient.id",
      "foreignField": "patient_id",
      "as": "patient"
    }
  },
  { "$unwind": "$patient" }
])
